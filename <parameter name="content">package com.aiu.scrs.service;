import com.aiu.scrs.entity.Complaint;
import com.aiu.scrs.entity.ComplaintVote;
import com.aiu.scrs.entity.User;
import com.aiu.scrs.repository.ComplaintVoteRepository;
import com.aiu.scrs.repository.ComplaintRepository;
import com.aiu.scrs.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

/**
 * Complaint Vote Service - Business logic for complaint voting operations
 */
@Service
@Transactional
public class ComplaintVoteService {

    @Autowired
    private ComplaintVoteRepository voteRepository;

    @Autowired
    private ComplaintRepository complaintRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ComplaintService complaintService;

    /**
     * Vote on a complaint
     */
    public Map<String, Object> voteOnComplaint(Long complaintId) {
        // Get current user
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));

        // Check if complaint exists
        Complaint complaint = complaintRepository.findById(complaintId)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));

        // Check if user already voted on this complaint
        Optional<ComplaintVote> existingVote = voteRepository.findByComplaintAndUser(complaint, user);
        if (existingVote.isPresent()) {
            throw new RuntimeException("User has already voted on this complaint");
        }

        // Create new vote
        ComplaintVote vote = new ComplaintVote();
        vote.setComplaint(complaint);
        vote.setUser(user);
        voteRepository.save(vote);

        // Increment vote count on complaint
        complaintService.incrementVoteCount(complaintId);

        // Get updated vote count
        int updatedVoteCount = voteRepository.countByComplaint(complaint);
        
        Map<String, Object> result = new HashMap<>();
        result.put("voteCount", updatedVoteCount);
        result.put("hasVoted", true);
        result.put("message", "Vote recorded successfully");
        
        return result;
    }

    /**
     * Remove vote from a complaint
     */
    public Map<String, Object> removeVoteFromComplaint(Long complaintId) {
        // Get current user
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));

        // Check if complaint exists
        Complaint complaint = complaintRepository.findById(complaintId)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));

        // Find and remove vote
        Optional<ComplaintVote> vote = voteRepository.findByComplaintAndUser(complaint, user);
        if (vote.isPresent()) {
            voteRepository.delete(vote.get());
            
            // Decrement vote count on complaint
            complaintService.decrementVoteCount(complaintId);
            
            // Get updated vote count
            int updatedVoteCount = voteRepository.countByComplaint(complaint);
            
            Map<String, Object> result = new HashMap<>();
            result.put("voteCount", updatedVoteCount);
            result.put("hasVoted", false);
            result.put("message", "Vote removed successfully");
            
            return result;
        } else {
            throw new RuntimeException("User has not voted on this complaint");
        }
    }

    /**
     * Check if current user has voted on a complaint
     */
    public boolean hasUserVoted(Long complaintId) {
        // Get current user
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));

        // Check if complaint exists
        Complaint complaint = complaintRepository.findById(complaintId)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));

        // Check if user has voted
        Optional<ComplaintVote> vote = voteRepository.findByComplaintAndUser(complaint, user);
        return vote.isPresent();
    }

    /**
     * Get vote count for a complaint
     */
    public int getVoteCount(Long complaintId) {
        // Check if complaint exists
        Complaint complaint = complaintRepository.findById(complaintId)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));

        return voteRepository.countByComplaint(complaint);
    }

    /**
     * Get top voted complaints
     */
    public Map<String, Object> getTopVotedComplaints() {
        // Get top voted complaints
        List<Complaint> topComplaints = complaintService.getTopVotedComplaints();
        
        Map<String, Object> result = new HashMap<>();
        result.put("topComplaints", topComplaints);
        result.put("count", topComplaints.size());
        
        return result;
    }

    /**
     * Get votes for a specific complaint (for detailed view)
     */
    public List<ComplaintVote> getVotesForComplaint(Long complaintId) {
        // Check if complaint exists
        Complaint complaint = complaintRepository.findById(complaintId)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));

        return voteRepository.findByComplaintOrderByCreatedAtDesc(complaint);
    }

    /**
     * Get all votes by current user
     */
    public List<ComplaintVote> getVotesByCurrentUser() {
        // Get current user
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));

        return voteRepository.findByUserOrderByCreatedAtDesc(user);
    }

    /**
     * Get user's voted complaints (for student dashboard)
     */
    public List<Complaint> getUserVotedComplaints() {
        // Get current user
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));

        return voteRepository.findUserVotedComplaints(user);
    }
}
</parameter>
<parameter name="path">/Users/mac/Desktop/soft/backend/src/main/java/com/aiu/scrs/service/ComplaintVoteService.java</parameter>
