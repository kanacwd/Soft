<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCRS - My Complaints</title>
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="complaints-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <h1>SCRS</h1>
        </div>
        <div class="nav-menu">
            <a href="#dashboard" class="nav-link">Dashboard</a>
            <a href="#submit-complaint" class="nav-link">Submit Complaint</a>
            <a href="#my-complaints" class="nav-link active">My Complaints</a>
            <a href="#public-complaints" class="nav-link">Browse Complaints</a>
        </div>
        <div class="nav-user">
            <span class="user-name" id="userName">Student User</span>
            <button class="btn btn-outline" id="logoutBtn">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="complaints-content">
        <div class="container">
            <!-- Header -->
            <div class="page-header">
                <h1>My Complaints</h1>
                <p>Track the status and progress of your submitted complaints</p>
            </div>

            <!-- Filters and Search -->
            <div class="filters-section">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search complaints..." class="form-control">
                    <button class="btn btn-outline" onclick="applyFilters()">
                        <i class="icon-search"></i>
                        Search
                    </button>
                </div>

                <div class="filter-controls">
                    <select id="statusFilter" class="form-control" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                        <option value="SUBMITTED">Submitted</option>
                        <option value="IN_REVIEW">In Review</option>
                        <option value="ASSIGNED">Assigned</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="CLOSED">Closed</option>
                    </select>

                    <select id="typeFilter" class="form-control" onchange="applyFilters()">
                        <option value="">All Types</option>
                        <option value="ACADEMIC">Academic</option>
                        <option value="INFRASTRUCTURE">Infrastructure</option>
                        <option value="SERVICES">Services</option>
                        <option value="ADMINISTRATIVE">Administrative</option>
                        <option value="FACULTY">Faculty</option>
                        <option value="OTHER">Other</option>
                    </select>

                    <select id="sortBy" class="form-control" onchange="applyFilters()">
                        <option value="createdAt,desc">Newest First</option>
                        <option value="createdAt,asc">Oldest First</option>
                        <option value="updatedAt,desc">Recently Updated</option>
                        <option value="priority,desc">Highest Priority</option>
                    </select>
                </div>
            </div>

            <!-- Complaints Statistics -->
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-label">Total Complaints:</span>
                    <span class="stat-value" id="totalCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pending:</span>
                    <span class="stat-value" id="pendingCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">In Progress:</span>
                    <span class="stat-value" id="inProgressCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Resolved:</span>
                    <span class="stat-value" id="resolvedCount">0</span>
                </div>
            </div>

            <!-- Complaints List -->
            <div class="complaints-container">
                <div id="complaintsList" class="complaints-grid">
                    <!-- Complaints will be loaded here -->
                </div>

                <!-- No Complaints Message -->
                <div id="noComplaints" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="icon-inbox"></i>
                    </div>
                    <h3>No Complaints Found</h3>
                    <p>You haven't submitted any complaints yet, or they don't match your current filters.</p>
                    <button class="btn btn-primary" onclick="router.navigate('#submit-complaint')">
                        Submit Your First Complaint
                    </button>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading your complaints...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination-container" id="paginationContainer" style="display: none;">
                <div class="pagination-info">
                    <span id="paginationInfo">Showing 1-10 of 25 complaints</span>
                </div>
                <div class="pagination-controls">
                    <button class="btn btn-outline" id="prevPageBtn" onclick="changePage(-1)">
                        <i class="icon-chevron-left"></i>
                        Previous
                    </button>
                    <div class="page-numbers" id="pageNumbers">
                        <!-- Page numbers will be generated here -->
                    </div>
                    <button class="btn btn-outline" id="nextPageBtn" onclick="changePage(1)">
                        Next
                        <i class="icon-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Complaint Detail Modal -->
    <div class="modal" id="complaintModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modalTitle">Complaint Details</h2>
                <button class="modal-close" onclick="closeModal('complaintModal')">&times;</button>
            </div>
            <div class="modal-body" id="complaintDetail">
                <!-- Complaint details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('complaintModal')">Close</button>
                <button class="btn btn-secondary" id="editComplaintBtn" onclick="editComplaint()">Edit</button>
                <button class="btn btn-primary" id="addCommentBtn" onclick="addComment()">Add Comment</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div class="modal" id="commentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Comment</h2>
                <button class="modal-close" onclick="closeModal('commentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="commentForm">
                    <div class="form-group">
                        <label for="commentText" class="form-label">Your Comment</label>
                        <textarea id="commentText" name="commentText" class="form-control" rows="4" 
                                  placeholder="Add your comment or update..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('commentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitComment()">Add Comment</button>
            </div>
        </div>
    </div>

    <!-- Edit Complaint Modal -->
    <div class="modal" id="editComplaintModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Edit Complaint</h2>
                <button class="modal-close" onclick="closeModal('editComplaintModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editComplaintForm">
                    <div class="form-group">
                        <label for="editTitle" class="form-label">Title</label>
                        <input type="text" id="editTitle" name="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea id="editDescription" name="description" class="form-control" rows="6" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editType" class="form-label">Type</label>
                            <select id="editType" name="type" class="form-control" required>
                                <option value="ACADEMIC">Academic</option>
                                <option value="INFRASTRUCTURE">Infrastructure</option>
                                <option value="SERVICES">Services</option>
                                <option value="ADMINISTRATIVE">Administrative</option>
                                <option value="FACULTY">Faculty</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editPriority" class="form-label">Priority</label>
                            <select id="editPriority" name="priority" class="form-control">
                                <option value="LOW">Low</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HIGH">High</option>
                                <option value="URGENT">Urgent</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editComplaintModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditComplaint()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/api.js"></script>
    <script src="../../js/router.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/jwt.js"></script>
    <script src="../../js/complaint.js"></script>

    <script>
        // Global variables
        let currentPage = 0;
        let pageSize = 10;
        let currentFilters = {};

        // Initialize page when it loads
        document.addEventListener('DOMContentLoaded', function() {
            if (!auth.isAuthenticated() || !auth.hasRole('STUDENT')) {
                router.navigate('#login');
                return;
            }
            
            myComplaints.init();
        });
    </script>
</body>
</html>
