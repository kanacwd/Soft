<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Complaints - SCRS</title>
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <h1>SCRS</h1>
                <span>Student Complaint Resolution System</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#/dashboard">Dashboard</a></li>
                    <li><a href="#/my-complaints">My Complaints</a></li>
                    <li><a href="#/public-complaints" class="active">Public Complaints</a></li>
                    <li><a href="#/submit-complaint">Submit Complaint</a></li>
                    <li><a href="#" id="logoutBtn">Logout</a></li>
                </ul>
            </nav>
        </div>

        <main class="main-content">
            <div class="page-header">
                <h1>Public Complaints</h1>
                <p>Browse and vote on public complaints from other students. Your votes help prioritize issues that need attention.</p>
            </div>

            <div class="filters-section">
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="search">Search</label>
                        <input type="text" id="search" placeholder="Search complaints...">
                    </div>
                    
                    <div class="filter-group">
                        <label for="categoryFilter">Category</label>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="ACADEMIC">Academic Issues</option>
                            <option value="ADMINISTRATIVE">Administrative</option>
                            <option value="INFRASTRUCTURE">Infrastructure</option>
                            <option value="SERVICES">Services</option>
                            <option value="HARASSMENT">Harassment/Bullying</option>
                            <option value="DISCRIMINATION">Discrimination</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="priorityFilter">Priority</label>
                        <select id="priorityFilter">
                            <option value="">All Priorities</option>
                            <option value="LOW">Low</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="HIGH">High</option>
                            <option value="CRITICAL">Critical</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="sortBy">Sort By</label>
                        <select id="sortBy">
                            <option value="voteCount">Most Votes</option>
                            <option value="createdAt">Newest First</option>
                            <option value="priority">Priority</option>
                            <option value="category">Category</option>
                        </select>
                    </div>
                </div>
                
                <div class="view-options">
                    <button id="gridView" class="view-btn active">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        Grid
                    </button>
                    <button id="listView" class="view-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="5" width="18" height="2"/>
                            <rect x="3" y="11" width="18" height="2"/>
                            <rect x="3" y="17" width="18" height="2"/>
                        </svg>
                        List
                    </button>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-number" id="totalComplaints">0</span>
                    <span class="stat-label">Total Public Complaints</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="avgVotes">0</span>
                    <span class="stat-label">Average Votes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="trendingIssues">0</span>
                    <span class="stat-label">Trending Issues</span>
                </div>
            </div>

            <div id="complaintsContainer" class="complaints-grid">
                <!-- Complaints will be loaded here -->
            </div>

            <div id="pagination" class="pagination">
                <!-- Pagination will be loaded here -->
            </div>

            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Loading complaints...</p>
            </div>
        </main>
    </div>

    <!-- Complaint Detail Modal -->
    <div id="complaintModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="modalTitle">Complaint Details</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="complaintDetails">
                    <!-- Complaint details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="../../js/api.js"></script>
    <script src="../../js/router.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/complaint.js"></script>
    <script>
        let currentPage = 0;
        let totalPages = 0;
        let currentView = 'grid';
        let complaints = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!auth.isAuthenticated()) {
                window.location.href = '#/login';
                return;
            }

            const user = auth.getCurrentUser();
            if (user.role !== 'STUDENT') {
                window.location.href = '#/dashboard';
                return;
            }

            // Initialize event listeners
            initializeEventListeners();

            // Load initial data
            loadPublicComplaints();
            loadStats();
        });

        function initializeEventListeners() {
            // Filter handlers
            document.getElementById('search').addEventListener('input', debounce(loadPublicComplaints, 500));
            document.getElementById('categoryFilter').addEventListener('change', loadPublicComplaints);
            document.getElementById('priorityFilter').addEventListener('change', loadPublicComplaints);
            document.getElementById('sortBy').addEventListener('change', loadPublicComplaints);

            // View toggle handlers
            document.getElementById('gridView').addEventListener('click', () => switchView('grid'));
            document.getElementById('listView').addEventListener('click', () => switchView('list'));

            // Modal handlers
            document.getElementById('closeModal').addEventListener('click', closeModal);
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('complaintModal')) {
                    closeModal();
                }
            });
        }

        async function loadPublicComplaints() {
            showLoading(true);
            try {
                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('size', 12);
                params.append('public', 'true');
                
                const search = document.getElementById('search').value;
                const category = document.getElementById('categoryFilter').value;
                const priority = document.getElementById('priorityFilter').value;
                const sortBy = document.getElementById('sortBy').value;

                if (search) params.append('search', search);
                if (category) params.append('category', category);
                if (priority) params.append('priority', priority);
                if (sortBy) params.append('sort', sortBy);

                const response = await complaintAPI.getPublicComplaints(params);
                
                if (response.success) {
                    complaints = response.data.content;
                    totalPages = response.data.totalPages;
                    renderComplaints(complaints);
                    renderPagination();
                } else {
                    showNotification('Failed to load complaints', 'error');
                }
            } catch (error) {
                console.error('Error loading public complaints:', error);
                showNotification('Failed to load complaints', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadStats() {
            try {
                const response = await complaintAPI.getPublicComplaintsStats();
                if (response.success && response.data) {
                    document.getElementById('totalComplaints').textContent = response.data.totalCount || 0;
                    document.getElementById('avgVotes').textContent = response.data.averageVotes || 0;
                    document.getElementById('trendingIssues').textContent = response.data.trendingCount || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function renderComplaints(complaints) {
            const container = document.getElementById('complaintsContainer');
            
            if (complaints.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“‹</div>
                        <h3>No Public Complaints Found</h3>
                        <p>There are no public complaints matching your current filters.</p>
                        <button class="btn btn-primary" onclick="window.location.href='#/submit-complaint'">
                            Submit the First Complaint
                        </button>
                    </div>
                `;
                return;
            }

            if (currentView === 'grid') {
                container.className = 'complaints-grid';
                container.innerHTML = complaints.map(complaint => createComplaintCard(complaint)).join('');
            } else {
                container.className = 'complaints-list';
                container.innerHTML = complaints.map(complaint => createComplaintListItem(complaint)).join('');
            }

            // Add event listeners for vote buttons
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', handleVote);
            });

            // Add event listeners for complaint cards
            document.querySelectorAll('.complaint-card, .complaint-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.vote-section')) {
                        const complaintId = e.currentTarget.dataset.complaintId;
                        showComplaintDetails(complaintId);
                    }
                });
            });
        }

        function createComplaintCard(complaint) {
            const isVoted = complaint.userVoted;
            const voteCount = complaint.voteCount || 0;
            
            return `
                <div class="complaint-card" data-complaint-id="${complaint.id}">
                    <div class="card-header">
                        <div class="complaint-meta">
                            <span class="complaint-id">#${complaint.id}</span>
                            <span class="complaint-date">${formatDate(complaint.createdAt)}</span>
                        </div>
                        <div class="priority-badge priority-${complaint.priority.toLowerCase()}">
                            ${complaint.priority}
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <h3 class="complaint-title">${escapeHtml(complaint.title)}</h3>
                        <p class="complaint-description">${escapeHtml(truncateText(complaint.description, 150))}</p>
                        
                        <div class="complaint-tags">
                            <span class="category-tag">${complaint.category}</span>
                            <span class="department-tag">${complaint.department}</span>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="vote-section">
                            <button class="vote-btn ${isVoted ? 'voted' : ''}" data-complaint-id="${complaint.id}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                                <span>${voteCount}</span>
                            </button>
                            <span class="vote-label">${voteCount === 1 ? 'Vote' : 'Votes'}</span>
                        </div>
                        
                        <button class="btn btn-secondary btn-sm" onclick="showComplaintDetails(${complaint.id})">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        }

        function createComplaintListItem(complaint) {
            const isVoted = complaint.userVoted;
            const voteCount = complaint.voteCount || 0;
            
            return `
                <div class="complaint-list-item" data-complaint-id="${complaint.id}">
                    <div class="list-item-header">
                        <div class="complaint-info">
                            <span class="complaint-id">#${complaint.id}</span>
                            <h3 class="complaint-title">${escapeHtml(complaint.title)}</h3>
                        </div>
                        <div class="vote-section">
                            <button class="vote-btn ${isVoted ? 'voted' : ''}" data-complaint-id="${complaint.id}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                                <span>${voteCount}</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="list-item-content">
                        <p class="complaint-description">${escapeHtml(truncateText(complaint.description, 200))}</p>
                        
                        <div class="complaint-meta-row">
                            <div class="meta-items">
                                <span class="category-tag">${complaint.category}</span>
                                <span class="department-tag">${complaint.department}</span>
                                <span class="priority-badge priority-${complaint.priority.toLowerCase()}">${complaint.priority}</span>
                                <span class="complaint-date">${formatDate(complaint.createdAt)}</span>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="showComplaintDetails(${complaint.id})">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function handleVote(event) {
            event.stopPropagation();
            
            const complaintId = event.currentTarget.dataset.complaintId;
            const voteBtn = event.currentTarget;
            const voteCount = voteBtn.querySelector('span');
            
            try {
                const isVoted = voteBtn.classList.contains('voted');
                const response = await complaintAPI.toggleVote(complaintId);
                
                if (response.success) {
                    // Update UI
                    if (isVoted) {
                        voteBtn.classList.remove('voted');
                        voteCount.textContent = parseInt(voteCount.textContent) - 1;
                    } else {
                        voteBtn.classList.add('voted');
                        voteCount.textContent = parseInt(voteCount.textContent) + 1;
                    }
                    
                    // Refresh stats
                    loadStats();
                } else {
                    showNotification(response.message || 'Failed to vote', 'error');
                }
            } catch (error) {
                console.error('Error voting:', error);
                showNotification('Failed to vote', 'error');
            }
        }

        async function showComplaintDetails(complaintId) {
            try {
                const response = await complaintAPI.getComplaintById(complaintId);
                
                if (response.success) {
                    const complaint = response.data;
                    renderComplaintDetails(complaint);
                    document.getElementById('complaintModal').style.display = 'flex';
                } else {
                    showNotification('Failed to load complaint details', 'error');
                }
            } catch (error) {
                console.error('Error loading complaint details:', error);
                showNotification('Failed to load complaint details', 'error');
            }
        }

        function renderComplaintDetails(complaint) {
            const details = document.getElementById('complaintDetails');
            const isVoted = complaint.userVoted;
            const voteCount = complaint.voteCount || 0;
            
            details.innerHTML = `
                <div class="complaint-detail-header">
                    <div class="detail-meta">
                        <span class="complaint-id">Complaint #${complaint.id}</span>
                        <span class="complaint-date">${formatDate(complaint.createdAt)}</span>
                    </div>
                    <div class="detail-actions">
                        <button class="vote-btn large ${isVoted ? 'voted' : ''}" onclick="toggleVote(${complaint.id})">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            <span>${voteCount} ${voteCount === 1 ? 'Vote' : 'Votes'}</span>
                        </button>
                    </div>
                </div>
                
                <div class="complaint-detail-content">
                    <h2>${escapeHtml(complaint.title)}</h2>
                    
                    <div class="detail-tags">
                        <span class="category-tag">${complaint.category}</span>
                        <span class="department-tag">${complaint.department}</span>
                        <span class="priority-badge priority-${complaint.priority.toLowerCase()}">${complaint.priority}</span>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Description</h3>
                        <p>${escapeHtml(complaint.description)}</p>
                    </div>
                    
                    ${complaint.suggestedResolution ? `
                        <div class="detail-section">
                            <h3>Suggested Resolution</h3>
                            <p>${escapeHtml(complaint.suggestedResolution)}</p>
                        </div>
                    ` : ''}
                    
                    <div class="detail-section">
                        <h3>Status Information</h3>
                        <div class="status-info">
                            <div class="status-item">
                                <span class="status-label">Current Status:</span>
                                <span class="status-value status-${complaint.status.toLowerCase()}">${complaint.status}</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Assigned Department:</span>
                                <span class="status-value">${complaint.department}</span>
                            </div>
                            ${complaint.assignedTo ? `
                                <div class="status-item">
                                    <span class="status-label">Assigned To:</span>
                                    <span class="status-value">${complaint.assignedTo}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${complaint.comments && complaint.comments.length > 0 ? `
                        <div class="detail-section">
                            <h3>Updates & Comments (${complaint.comments.length})</h3>
                            <div class="comments-list">
                                ${complaint.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">${comment.author}</span>
                                            <span class="comment-date">${formatDate(comment.createdAt)}</span>
                                        </div>
                                        <div class="comment-content">${escapeHtml(comment.content)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('complaintModal').style.display = 'none';
        }

        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('gridView').classList.toggle('active', view === 'grid');
            document.getElementById('listView').classList.toggle('active', view === 'list');
            
            // Re-render complaints with new view
            renderComplaints(complaints);
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `
                <button class="pagination-btn ${currentPage === 0 ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>
                    Previous
                </button>
            `;
            
            // Page numbers
            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="changePage(${i})">
                        ${i + 1}
                    </button>
                `;
            }
            
            // Next button
            paginationHtml += `
                <button class="pagination-btn ${currentPage === totalPages - 1 ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage + 1})" ${currentPage === totalPages - 1 ? 'disabled' : ''}>
                    Next
                </button>
            `;
            
            pagination.innerHTML = paginationHtml;
        }

        function changePage(page) {
            if (page >= 0 && page < totalPages) {
                currentPage = page;
                loadPublicComplaints();
            }
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '<',
                '>': '>',
                '"': '"',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Global function for vote button in modal
        window.toggleVote = function(complaintId) {
            // This will be handled by the event listener system
            const voteBtn = document.querySelector(`[data-complaint-id="${complaintId}"]`);
            if (voteBtn) {
                voteBtn.click();
                // Update modal if it's open
                if (document.getElementById('complaintModal').style.display === 'flex') {
                    showComplaintDetails(complaintId);
                }
            }
        };

        // Global function for showing complaint details
        window.showComplaintDetails = showComplaintDetails;

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            setTimeout(() => notification.remove(), 5000);
        }
    </script>
</body>
</html>
