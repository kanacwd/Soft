<parameter name="content">package com.aiu.scrs.service;

import com.aiu.scrs.dto.complaint.ComplaintRequest;
import com.aiu.scrs.entity.*;
import com.aiu.scrs.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

/**
 * Complaint Service - Business logic for complaint operations
 */
@Service
@Transactional
public class ComplaintService {

    @Autowired
    private ComplaintRepository complaintRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private DepartmentRepository departmentRepository;

    @Autowired
    private ComplaintVoteRepository voteRepository;

    @Autowired
    private ComplaintStatusHistoryRepository statusHistoryRepository;

    /**
     * Get all complaints (Admin/Staff only)
     */
    public List<Complaint> getAllComplaints() {
        return complaintRepository.findAllByOrderByCreatedAtDesc();
    }

    /**
     * Get complaint by ID
     */
    public Optional<Complaint> getComplaintById(Long id) {
        return complaintRepository.findById(id);
    }

    /**
     * Get complaints by current user (Student only)
     */
    public List<Complaint> getComplaintsByCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));
            
        return complaintRepository.findByStudentOrderByCreatedAtDesc(user);
    }

    /**
     * Get complaints by status
     */
    public List<Complaint> getComplaintsByStatus(ComplaintStatus status) {
        return complaintRepository.findByStatusOrderByCreatedAtDesc(status);
    }

    /**
     * Get complaints by type
     */
    public List<Complaint> getComplaintsByType(ComplaintType type) {
        return complaintRepository.findByTypeOrderByCreatedAtDesc(type);
    }

    /**
     * Get public complaints (for display without authentication)
     */
    public List<Complaint> getPublicComplaints() {
        return complaintRepository.findByIsPublicTrueOrderByCreatedAtDesc();
    }

    /**
     * Get top voted complaints
     */
    public List<Complaint> getTopVotedComplaints() {
        return complaintRepository.findTopVotedComplaints();
    }

    /**
     * Create new complaint
     */
    public Complaint createComplaint(ComplaintRequest request) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));

        Complaint complaint = new Complaint();
        complaint.setTitle(request.getTitle());
        complaint.setDescription(request.getDescription());
        complaint.setType(request.getType());
        complaint.setStatus(ComplaintStatus.PENDING);
        complaint.setStudent(user);
        complaint.setIsPublic(request.getIsPublic() != null ? request.getIsPublic() : true);
        complaint.setVoteCount(0);
        complaint.setCreatedAt(LocalDateTime.now());

        // Set department if provided
        if (request.getDepartmentId() != null) {
            Department department = departmentRepository.findById(request.getDepartmentId())
                .orElseThrow(() -> new RuntimeException("Department not found"));
            complaint.setDepartment(department);
        }

        return complaintRepository.save(complaint);
    }

    /**
     * Update complaint status
     */
    public Complaint updateComplaintStatus(Long id, ComplaintStatus status) {
        Complaint complaint = complaintRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));

        ComplaintStatus oldStatus = complaint.getStatus();
        complaint.setStatus(status);
        complaint.setUpdatedAt(LocalDateTime.now());

        // Save status history
        ComplaintStatusHistory history = new ComplaintStatusHistory();
        history.setComplaint(complaint);
        history.setOldStatus(oldStatus);
        history.setNewStatus(status);
        history.setChangedAt(LocalDateTime.now());
        statusHistoryRepository.save(history);

        return complaintRepository.save(complaint);
    }

    /**
     * Assign complaint to staff member
     */
    public Complaint assignComplaint(Long id, Long staffId) {
        Complaint complaint = complaintRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));

        User staff = userRepository.findById(staffId)
            .orElseThrow(() -> new RuntimeException("Staff member not found"));

        if (staff.getRole() != UserRole.STAFF && staff.getRole() != UserRole.ADMIN) {
            throw new RuntimeException("Assigned user must be a staff member or admin");
        }

        complaint.setAssignedTo(staff);
        complaint.setUpdatedAt(LocalDateTime.now());

        return complaintRepository.save(complaint);
    }

    /**
     * Delete complaint
     */
    public void deleteComplaint(Long id) {
        complaintRepository.deleteById(id);
    }

    /**
     * Get assigned complaints for current staff
     */
    public List<Complaint> getAssignedComplaints() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("User not found"));
            
        return complaintRepository.findByAssignedToOrderByCreatedAtDesc(user);
    }

    /**
     * Search complaints
     */
    public List<Complaint> searchComplaints(String keyword) {
        return complaintRepository.searchComplaints(keyword);
    }

    /**
     * Increment vote count
     */
    public void incrementVoteCount(Long complaintId) {
        Complaint complaint = complaintRepository.findById(complaintId)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));
        
        Integer currentCount = complaint.getVoteCount();
        if (currentCount == null) currentCount = 0;
        complaint.setVoteCount(currentCount + 1);
        complaintRepository.save(complaint);
    }

    /**
     * Decrement vote count
     */
    public void decrementVoteCount(Long complaintId) {
        Complaint complaint = complaintRepository.findById(complaintId)
            .orElseThrow(() -> new RuntimeException("Complaint not found"));
        
        Integer currentCount = complaint.getVoteCount();
        if (currentCount == null) currentCount = 0;
        complaint.setVoteCount(Math.max(0, currentCount - 1));
        complaintRepository.save(complaint);
    }
}
</parameter>
